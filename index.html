<!DOCTYPE html>
<html lang="ja">
<head>
  <meta charset="UTF-8">
  <title>ãƒªãƒƒãƒãƒ†ã‚­ã‚¹ãƒˆã‚¨ãƒ‡ã‚£ã‚¿</title>
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <link rel="manifest" href="manifest.json">
  <meta name="theme-color" content="#ffffff">
  <link rel="icon" href="icons/icon-192.png" type="image/png">
  <style>
    /* --- ãƒªã‚»ãƒƒãƒˆ --- */
    html, body {
      margin: 0; padding: 0;
    }
    body {
      font-family: sans-serif;
    }
    /* --- ãƒ˜ãƒƒãƒ€ãƒ¼ --- */
    #toolbar {
      padding: 8px;
      background: #f0f0f0;
      border-bottom: 1px solid #ccc;
      position: sticky; top: 0; z-index: 1000;
      display: flex; align-items: center; gap: 8px;
    }
    /* ãƒ˜ãƒƒãƒ€ãƒ¼ã«æ®‹ã™ãƒœã‚¿ãƒ³ */
    #toolbar button, #toolbar input[type=file] {
      display: flex;
      margin-right: 4px;
    }
    /* --- ã‚³ãƒ³ãƒ†ãƒŠ --- */
    #container {
      display: flex;
      height: calc(100vh - 50px);
    }
    /* --- ã‚µã‚¤ãƒ‰ãƒãƒ¼ï¼ˆã‚¢ã‚¦ãƒˆãƒ©ã‚¤ãƒ³ï¼‰ --- */
    #sidebar {
      width: 200px;
      max-width: 500px;
      background: #f9f9f9;
      border-right: 1px solid #ccc;
      padding: 4px 8px;
      box-sizing: border-box;
      overflow-y: auto;
      position: relative;
      transition: width 0.2s ease;
    }
    #sidebar.hidden {
      width: 0;
      padding: 0;
      overflow: hidden;
    }
    #sidebar p{ font-size: small; color: #7d7d7d; }
    #outline { list-style:none; padding:0; margin:0; }
    #outline li { margin:0px 0; }
    #outline li.active > a { background:#ddd; }
    #outline .outline-item { text-decoration:none; color:#333333; display:block; padding:4px; border-radius:4px; cursor:pointer; transition: background-color 0.2s; }
    #outline .outline-item:hover { background:#f0f0f0; }
    #outline .outline-item.active { background:#e0e0e0;  font-weight:bold; }

    #toggleSidebar {
      position: static;
      top: 0.5em;
      leftt: 0.5em;
      width: 1.5em;
      height: 1.5em;
      border: 1px solid #999;
      border-radius: 0.25em;
      cursor: pointer;
      display: flex;
      align-items: center;
      justify-content: center;
      z-index: 10;
      visibility: visible !important;
    }

    #resizer {
      width: 5px;
      cursor: col-resize;
      background-color: transparent;
      position: absolute;
      top: 0;
      right: 0;
      height: 100%;
      z-index: 9;
    }

    /* --- ã‚¨ãƒ‡ã‚£ã‚¿é ˜åŸŸ --- */
    #editor {
      flex: 1;
      padding: 10px;
      overflow-y: auto;
      position: relative;
    }
    /* ãƒªã‚µã‚¤ã‚ºç”¨ã‚³ãƒ³ãƒ†ãƒŠ */
    .resizable-container {
      display: block;
      resize: both; overflow: auto;
      max-width: 100%;
      max-height: fit-content;
      margin:1em 0;
      border:1px dashed #ccc; position: relative;
    }
    .resizable-container img {
      width:100%; height:auto; display:block;
    }
    /* --- æµ®å‹•ãƒ„ãƒ¼ãƒ«ãƒãƒ¼ --- */
    #float-toolbar {
      position: absolute;
      display: none;
      background: #fff;
      border: 1px solid #ccc;
      border-radius: 4px;
      box-shadow: 0 2px 6px rgba(0,0,0,0.2);
      padding: 4px;
      z-index: 1001;
      display: flex;
      gap: 4px;
      align-items: center;
    }
    #float-toolbar button, #float-toolbar select {
      background: none;
      border: none;
      padding: 8px;
      cursor: pointer;
      font-size: 14px;
      border-radius: 3px;
    }
    #float-toolbar button:hover, #float-toolbar select:hover {
      background: #eee;
    }
    
    /* ã‚«ãƒ©ãƒ¼ãƒ”ãƒƒã‚«ãƒ¼é–¢é€£ */
    .color-picker-container {
      position: relative;
      display: inline-block;
    }
    
    .color-picker {
      position: absolute;
      top: 100%;
      left: 0;
      background: white;
      border: 1px solid #ccc;
      border-radius: 4px;
      padding: 8px;
      display: none;
      z-index: 1002;
      box-shadow: 0 2px 8px rgba(0,0,0,0.15);
      grid-template-columns: repeat(5, 1fr);
      gap: 4px;
      min-width: 120px;
    }
    
    .color-picker.show {
      display: grid;
    }
    
    .color-option {
      width: 20px;
      height: 20px;
      border-radius: 3px;
      cursor: pointer;
      border: 1px solid #ddd;
      display: flex;
      align-items: center;
      justify-content: center;
      font-size: 12px;
    }
    
    .color-option:hover {
      border-color: #999;
      transform: scale(1.1);
    }
    
    #textColorBtn {
      color: #000;
      font-weight: bold;
      position: relative;
    }
    
    #textColorBtn::after {
      content: '';
      position: absolute;
      bottom: 2px;
      left: 50%;
      transform: translateX(-50%);
      width: 12px;
      height: 2px;
      background: currentColor;
    }
  </style>
</head>
<body>

  <!-- ãƒ˜ãƒƒãƒ€ãƒ¼ï¼šãƒ•ã‚¡ã‚¤ãƒ«é¸æŠãƒ»ä¿å­˜ã®ã¿ -->
  <div id="toolbar">
    <div id="toggleSidebar" title="æŠ˜ã‚ŠãŸãŸã¿">Â«</div>
    <input type="file" accept=".html" onchange="loadFile(event)" title="èª­ã¿è¾¼ã¿">
    <button onclick="save()">ğŸ’¾ ä¿å­˜</button>
  </div>

  <div id="container">
    <!-- ã‚¢ã‚¦ãƒˆãƒ©ã‚¤ãƒ³ -->
    <div id="sidebar">
      <div id="resizer"></div>
      <P>ã‚¢ã‚¦ãƒˆãƒ©ã‚¤ãƒ³</P>
      <ul id="outline"></ul>
    </div>


    <!-- ç·¨é›†é ˜åŸŸ -->
    <div id="editor" contenteditable="true"
         ondrop="handleDrop(event)" ondragover="e=>e.preventDefault()">
      <h1>ã“ã“ã«æ–‡ç« ã‚’å…¥åŠ›ã—ã¦ãã ã•ã„...</h1>
    </div>
  </div>

  <!-- é¸æŠç¯„å›²æµ®å‹•ãƒ„ãƒ¼ãƒ«ãƒãƒ¼ -->
  <div id="float-toolbar">
    <button onclick="exec('bold')" title="å¤ªå­—">B</button>
    <button onclick="exec('italic')" title="æ–œä½“">I</button>
    <button onclick="exec('underline')" title="ä¸‹ç·š">U</button>
    <button onclick="exec('insertUnorderedList')" title="ç®‡æ¡æ›¸ã">â€¢ List</button>
    <button onclick="exec('insertOrderedList')" title="ç•ªå·ä»˜ããƒªã‚¹ãƒˆ">1. List</button>
    <select onchange="exec('formatBlock', this.value)" title="è¦‹å‡ºã—/æ®µè½">
      <option value="P">ãƒ†ã‚­ã‚¹ãƒˆ</option>
      <option value="H1">è¦‹å‡ºã—1</option>
      <option value="H2">è¦‹å‡ºã—2</option>
      <option value="H3">è¦‹å‡ºã—3</option>
      <option value="H4">è¦‹å‡ºã—4</option>
    </select>
    <div class="color-picker-container">
      <button onclick="toggleColorPicker('text')" title="æ–‡å­—è‰²" id="textColorBtn">A</button>
      <div id="textColorPicker" class="color-picker">
        <div class="color-option" style="background-color: #000000" onclick="setTextColor('#000000')" title="é»’"></div>
        <div class="color-option" style="background-color: #ff0000" onclick="setTextColor('#ff0000')" title="èµ¤"></div>
        <div class="color-option" style="background-color: #00ff00" onclick="setTextColor('#00ff00')" title="ç·‘"></div>
        <div class="color-option" style="background-color: #0000ff" onclick="setTextColor('#0000ff')" title="é’"></div>
        <div class="color-option" style="background-color: #ffff00" onclick="setTextColor('#ffff00')" title="é»„"></div>
        <div class="color-option" style="background-color: #ff00ff" onclick="setTextColor('#ff00ff')" title="ãƒã‚¼ãƒ³ã‚¿"></div>
        <div class="color-option" style="background-color: #00ffff" onclick="setTextColor('#00ffff')" title="ã‚·ã‚¢ãƒ³"></div>
        <div class="color-option" style="background-color: #800080" onclick="setTextColor('#800080')" title="ç´«"></div>
        <div class="color-option" style="background-color: #ffa500" onclick="setTextColor('#ffa500')" title="ã‚ªãƒ¬ãƒ³ã‚¸"></div>
        <div class="color-option" style="background-color: #808080" onclick="setTextColor('#808080')" title="ã‚°ãƒ¬ãƒ¼"></div>
      </div>
    </div>
    <div class="color-picker-container">
      <button onclick="toggleColorPicker('highlight')" title="ãƒã‚¤ãƒ©ã‚¤ãƒˆ" id="highlightBtn">ğŸ–</button>
      <div id="highlightColorPicker" class="color-picker">
        <div class="color-option" style="background-color: transparent; border: 1px solid #ccc" onclick="setHighlightColor('transparent')" title="ãªã—">Ã—</div>
        <div class="color-option" style="background-color: #ffff00" onclick="setHighlightColor('#ffff00')" title="é»„"></div>
        <div class="color-option" style="background-color: #00ff00" onclick="setHighlightColor('#00ff00')" title="ç·‘"></div>
        <div class="color-option" style="background-color: #00ffff" onclick="setHighlightColor('#00ffff')" title="ã‚·ã‚¢ãƒ³"></div>
        <div class="color-option" style="background-color: #ff00ff" onclick="setHighlightColor('#ff00ff')" title="ãƒã‚¼ãƒ³ã‚¿"></div>
        <div class="color-option" style="background-color: #ffa500" onclick="setHighlightColor('#ffa500')" title="ã‚ªãƒ¬ãƒ³ã‚¸"></div>
        <div class="color-option" style="background-color: #ff69b4" onclick="setHighlightColor('#ff69b4')" title="ãƒ”ãƒ³ã‚¯"></div>
        <div class="color-option" style="background-color: #90ee90" onclick="setHighlightColor('#90ee90')" title="ãƒ©ã‚¤ãƒˆã‚°ãƒªãƒ¼ãƒ³"></div>
        <div class="color-option" style="background-color: #ffb6c1" onclick="setHighlightColor('#ffb6c1')" title="ãƒ©ã‚¤ãƒˆãƒ”ãƒ³ã‚¯"></div>
        <div class="color-option" style="background-color: #d3d3d3" onclick="setHighlightColor('#d3d3d3')" title="ãƒ©ã‚¤ãƒˆã‚°ãƒ¬ãƒ¼"></div>
      </div>
    </div>
  </div>

  <script>
  // PWA ServiceWorker ç™»éŒ²
  if ('serviceWorker' in navigator) {
    navigator.serviceWorker.register('service-worker.js');
  }

  let currentFilename = 'document.html';
  const editor = document.getElementById('editor');
  const floatBar = document.getElementById('float-toolbar');

  // ã‚¢ã‚¦ãƒˆãƒ©ã‚¤ãƒ³æ›´æ–°é–¢æ•°ã‚’ã‚°ãƒ­ãƒ¼ãƒãƒ«ã‚¹ã‚³ãƒ¼ãƒ—ã«å®šç¾©
  function updateOutline() {
    const outline = document.getElementById('outline');
    outline.innerHTML = '';

    const headings = editor.querySelectorAll('h1, h2, h3, h4');
    headings.forEach((h, idx) => {
      const level = parseInt(h.tagName.substring(1));
      const link = document.createElement('div');
      link.textContent = h.textContent;
      link.style.marginLeft = (level - 1) * 16 + 'px';
      link.className = 'outline-item';
      link.dataset.headingIndex = idx; // è¦‹å‡ºã—ã®ã‚¤ãƒ³ãƒ‡ãƒƒã‚¯ã‚¹ã‚’ä¿å­˜
      link.onclick = () => {
        // ã‚¹ã‚¯ãƒ­ãƒ¼ãƒ«ã—ã¦è¦‹å‡ºã—ã‚’ä¸­å¤®ã«è¡¨ç¤º
        h.scrollIntoView({ behavior: 'smooth', block: 'center' });

        // è¦‹å‡ºã—ã«ã‚«ãƒ¼ã‚½ãƒ«ï¼ˆã‚­ãƒ£ãƒ¬ãƒƒãƒˆï¼‰ã‚’ç§»å‹•
        const range = document.createRange();
        range.selectNodeContents(h);
        range.collapse(true);

        const selection = window.getSelection();
        selection.removeAllRanges();
        selection.addRange(range);
        
        // ã‚¢ã‚¦ãƒˆãƒ©ã‚¤ãƒ³ã‚’ãƒã‚¤ãƒ©ã‚¤ãƒˆ
        updateOutlineHighlight();
      };
      outline.appendChild(link);
    });
    
    // ç¾åœ¨ã®ã‚«ãƒ¼ã‚½ãƒ«ä½ç½®ã«åŸºã¥ã„ã¦ãƒã‚¤ãƒ©ã‚¤ãƒˆã‚’æ›´æ–°
    updateOutlineHighlight();
  }

  // ã‚¢ã‚¦ãƒˆãƒ©ã‚¤ãƒ³ã®ãƒã‚¤ãƒ©ã‚¤ãƒˆã‚’æ›´æ–°ã™ã‚‹é–¢æ•°
  function updateOutlineHighlight() {
    const selection = window.getSelection();
    if (!selection.rangeCount) return;

    const range = selection.getRangeAt(0);
    const currentElement = range.startContainer.nodeType === Node.TEXT_NODE 
      ? range.startContainer.parentElement 
      : range.startContainer;

    // ç¾åœ¨ã®è¦ç´ ã‹ã‚‰æœ€ã‚‚è¿‘ã„è¦‹å‡ºã—ã‚’è¦‹ã¤ã‘ã‚‹
    let targetHeading = findCurrentOrPreviousHeading(currentElement);
    
    // å…¨ã¦ã®ã‚¢ã‚¦ãƒˆãƒ©ã‚¤ãƒ³é …ç›®ã‹ã‚‰activeã‚¯ãƒ©ã‚¹ã‚’å‰Šé™¤
    const outlineItems = document.querySelectorAll('.outline-item');
    outlineItems.forEach(item => item.classList.remove('active'));

    // å¯¾è±¡ã®è¦‹å‡ºã—ãŒã‚ã‚‹å ´åˆã€å¯¾å¿œã™ã‚‹ã‚¢ã‚¦ãƒˆãƒ©ã‚¤ãƒ³é …ç›®ã‚’ãƒã‚¤ãƒ©ã‚¤ãƒˆ
    if (targetHeading) {
      const headings = editor.querySelectorAll('h1, h2, h3, h4');
      const headingIndex = Array.from(headings).indexOf(targetHeading);
      if (headingIndex >= 0) {
        const targetOutlineItem = document.querySelector(`[data-heading-index="${headingIndex}"]`);
        if (targetOutlineItem) {
          targetOutlineItem.classList.add('active');
        }
      }
    }
  }

  // ç¾åœ¨ã®è¦ç´ ã¾ãŸã¯æ‰‹å‰ã®è¦‹å‡ºã—ã‚’è¦‹ã¤ã‘ã‚‹é–¢æ•°
  function findCurrentOrPreviousHeading(element) {
    // ç¾åœ¨ã®è¦ç´ ãŒè¦‹å‡ºã—ã®å ´åˆã¯ãã‚Œã‚’è¿”ã™
    if (element && element.matches && element.matches('h1, h2, h3, h4')) {
      return element;
    }

    // ã‚¨ãƒ‡ã‚£ã‚¿å†…ã®å…¨ã¦ã®è¦ç´ ã‚’å–å¾—
    const allElements = Array.from(editor.querySelectorAll('*'));
    const currentIndex = allElements.indexOf(element);

    // ç¾åœ¨ã®è¦ç´ ã‹ã‚‰å‰æ–¹ã«å‘ã‹ã£ã¦è¦‹å‡ºã—ã‚’æ¢ã™
    for (let i = currentIndex; i >= 0; i--) {
      const el = allElements[i];
      if (el.matches('h1, h2, h3, h4')) {
        return el;
      }
    }

    // ç¾åœ¨ã®è¦ç´ ã®è¦ªè¦ç´ ã‹ã‚‰å‰æ–¹ã®å…„å¼Ÿè¦ç´ ã‚’æ¢ã™
    let current = element;
    while (current && current !== editor) {
      let prev = current.previousElementSibling;
      while (prev) {
        if (prev.matches('h1, h2, h3, h4')) {
          return prev;
        }
        // å‰ã®è¦ç´ ã®å­è¦ç´ å†…ã®è¦‹å‡ºã—ã‚‚ç¢ºèª
        const headingInPrev = prev.querySelector('h1, h2, h3, h4:last-of-type');
        if (headingInPrev) {
          return headingInPrev;
        }
        prev = prev.previousElementSibling;
      }
      current = current.parentElement;
    }

    return null;
  }

  // æ¨™æº–ã‚³ãƒãƒ³ãƒ‰å®Ÿè¡Œ
  function exec(cmd, val=null){
    document.execCommand(cmd, false, val);
    editor.focus();
    hideFloatBar();
  }

  // ã‚«ãƒ©ãƒ¼ãƒ”ãƒƒã‚«ãƒ¼ã®è¡¨ç¤º/éè¡¨ç¤º
  function toggleColorPicker(type) {
    const pickerId = type === 'text' ? 'textColorPicker' : 'highlightColorPicker';
    const picker = document.getElementById(pickerId);
    const otherPicker = document.getElementById(type === 'text' ? 'highlightColorPicker' : 'textColorPicker');
    
    // ä»–ã®ãƒ”ãƒƒã‚«ãƒ¼ã‚’é–‰ã˜ã‚‹
    otherPicker.classList.remove('show');
    
    // ç¾åœ¨ã®ãƒ”ãƒƒã‚«ãƒ¼ã‚’ãƒˆã‚°ãƒ«
    picker.classList.toggle('show');
  }

  // æ–‡å­—è‰²ã‚’è¨­å®š
  function setTextColor(color) {
    document.execCommand('foreColor', false, color);
    
    // ãƒœã‚¿ãƒ³ã®è‰²ã‚’æ›´æ–°
    const btn = document.getElementById('textColorBtn');
    btn.style.color = color;
    
    // ãƒ”ãƒƒã‚«ãƒ¼ã‚’é–‰ã˜ã‚‹
    document.getElementById('textColorPicker').classList.remove('show');
    editor.focus();
  }

  // ãƒã‚¤ãƒ©ã‚¤ãƒˆè‰²ã‚’è¨­å®š
  function setHighlightColor(color) {
    if (color === 'transparent') {
      // ãƒã‚¤ãƒ©ã‚¤ãƒˆã‚’å‰Šé™¤
      document.execCommand('hiliteColor', false, 'transparent');
      document.execCommand('backColor', false, 'transparent');
    } else {
      // ãƒã‚¤ãƒ©ã‚¤ãƒˆè‰²ã‚’è¨­å®š
      document.execCommand('hiliteColor', false, color);
      // Firefoxãªã©ä¸€éƒ¨ãƒ–ãƒ©ã‚¦ã‚¶ç”¨ã®ä»£æ›¿
      if (!document.queryCommandSupported('hiliteColor')) {
        document.execCommand('backColor', false, color);
      }
    }
    
    // ãƒ”ãƒƒã‚«ãƒ¼ã‚’é–‰ã˜ã‚‹
    document.getElementById('highlightColorPicker').classList.remove('show');
    editor.focus();
  }

  // ä¿å­˜
  function save(){
    const content = editor.innerHTML;
    const html = `<!DOCTYPE html><html><body>${content}</body></html>`;
    const blob = new Blob([html], {type:'text/html'});
    const a = document.createElement('a');
    a.href = URL.createObjectURL(blob);
    a.download = currentFilename;
    a.click();
  }

  // èª­ã¿è¾¼ã¿
  function loadFile(e){
    const f = e.target.files[0];
    if(!f) return;
    currentFilename = f.name;
    const r = new FileReader();
    r.onload = ev => {
      const tmp = document.createElement('div');
      tmp.innerHTML = ev.target.result;
      const b = tmp.querySelector('body');
      editor.innerHTML = b ? b.innerHTML : tmp.innerHTML;
      // ãƒ•ã‚¡ã‚¤ãƒ«èª­ã¿è¾¼ã¿å¾Œã«ã‚¢ã‚¦ãƒˆãƒ©ã‚¤ãƒ³ã‚’æ›´æ–°
      updateOutline();
    };
    r.readAsText(f);
    document.body.style.margin = '0';
    document.body.style.padding = '0';
  }

  // PWA ServiceWorker ç™»éŒ²ï¼ˆé‡è¤‡å‰Šé™¤ï¼‰
  if ('serviceWorker' in navigator) {
    window.addEventListener('load', () => {
      navigator.serviceWorker.register('sw.js');
    });
  }

  document.addEventListener('DOMContentLoaded', () => {
    // ã‚¢ã‚¦ãƒˆãƒ©ã‚¤ãƒ³ã‚’è‡ªå‹•æ›´æ–°
    editor.addEventListener('input', updateOutline);
    editor.addEventListener('keydown', updateOutline);
    editor.addEventListener('mouseup', updateOutline);

    // ã‚«ãƒ¼ã‚½ãƒ«ä½ç½®å¤‰æ›´æ™‚ã®ãƒã‚¤ãƒ©ã‚¤ãƒˆæ›´æ–°
    editor.addEventListener('keyup', updateOutlineHighlight);
    editor.addEventListener('click', updateOutlineHighlight);
    document.addEventListener('selectionchange', () => {
      // selectionå¤‰æ›´ãŒã‚¨ãƒ‡ã‚£ã‚¿å†…ã§ç™ºç”Ÿã—ãŸå ´åˆã®ã¿å‡¦ç†
      const selection = window.getSelection();
      if (selection.rangeCount > 0) {
        const range = selection.getRangeAt(0);
        const container = range.commonAncestorContainer;
        if (editor.contains(container) || container === editor) {
          updateOutlineHighlight();
        }
      }
    });

    // ã‚µã‚¤ãƒ‰ãƒãƒ¼ã®æŠ˜ã‚ŠãŸãŸã¿
    const sidebar = document.getElementById('sidebar');
    const toggleSidebarBtn = document.getElementById('toggleSidebar');
    toggleSidebarBtn.addEventListener('click', () => {
      sidebar.classList.toggle('hidden');
      toggleSidebarBtn.innerText = sidebar.classList.contains('hidden') ? 'â˜°' : 'Â«';
    });

    // ã‚µã‚¤ãƒ‰ãƒãƒ¼å¹…ã®ãƒªã‚µã‚¤ã‚º
    const resizer = document.getElementById('resizer');
    let isResizing = false;

    resizer.addEventListener('mousedown', (e) => {
      isResizing = true;
      document.body.style.cursor = 'col-resize';
    });

    document.addEventListener('mousemove', (e) => {
      if (!isResizing) return;
      const newWidth = e.clientX;
      sidebar.style.width = `${Math.max(100, Math.min(500, newWidth))}px`;
    });

    document.addEventListener('mouseup', () => {
      isResizing = false;
      document.body.style.cursor = 'default';
    });

    // åˆæœŸåŒ–
    updateOutline();
  });

  // ç”»åƒãƒ‰ãƒ­ãƒƒãƒ—ï¼æŒ¿å…¥
  function handleDrop(e){
    e.preventDefault();
    Array.from(e.dataTransfer.files).forEach(file=>{
      if(file.type.startsWith('image/')){
        const reader = new FileReader();
        reader.onload=ev=>{
          const wrap = document.createElement('div');
          wrap.className='resizable-container';
          const img = document.createElement('img');
          img.src = ev.target.result;
          wrap.appendChild(img);
          insertAtCursor(wrap);
        };
        reader.readAsDataURL(file);
      }
    });
    updateOutline();
  }

  // ã‚«ãƒ¼ã‚½ãƒ«ä½ç½®ã«ãƒãƒ¼ãƒ‰æŒ¿å…¥
  function insertAtCursor(node){
    const sel = window.getSelection();
    if(!sel.rangeCount) return;
    const range = sel.getRangeAt(0);
    range.deleteContents();
    range.insertNode(node);
  }

  // é¸æŠç¯„å›²æ™‚ã«æµ®å‹•ãƒ¡ãƒ‹ãƒ¥ãƒ¼è¡¨ç¤º
  document.addEventListener('mouseup', e=>{
    setTimeout(()=>{ // é¸æŠåæ˜ å¾…ã¡
      const sel = window.getSelection();
      if(sel.isCollapsed) { hideFloatBar(); return; }
      const range = sel.getRangeAt(0);
      const rect = range.getBoundingClientRect();
      // è¡¨ç¤ºä½ç½®ï¼šé¸æŠç¯„å›²ã®ä¸Šã‚»ãƒ³ã‚¿ãƒ¼
      floatBar.style.position = "absolute";
      floatBar.style.top = (window.scrollY + rect.top - floatBar.offsetHeight - 48)+'px';
      floatBar.style.left = (window.scrollX + rect.left)+'px';
      floatBar.style.display = 'flex';
    }, 10);
  });

  // éè¡¨ç¤º
  function hideFloatBar(){
    floatBar.style.display = 'none';
    // ã‚«ãƒ©ãƒ¼ãƒ”ãƒƒã‚«ãƒ¼ã‚‚é–‰ã˜ã‚‹
    document.getElementById('textColorPicker').classList.remove('show');
    document.getElementById('highlightColorPicker').classList.remove('show');
  }

  // ã‚¯ãƒªãƒƒã‚¯æ™‚ã«æ¶ˆã™ï¼ˆé¸æŠå¤–ï¼‰
  document.addEventListener('mousedown', e=>{
    if(!floatBar.contains(e.target)) {
      hideFloatBar();
    }
  });

  </script>

</body>
</html>