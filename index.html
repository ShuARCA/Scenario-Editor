<!DOCTYPE html>
<html lang="ja">
<head>
  <meta charset="UTF-8">
  <title>ãƒªãƒƒãƒãƒ†ã‚­ã‚¹ãƒˆã‚¨ãƒ‡ã‚£ã‚¿</title>
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <link rel="manifest" href="manifest.json">
  <meta name="theme-color" content="#fffff9">
  <link rel="icon" href="icons/icon-192.png" type="image/png">
  <style>
    /* --- ãƒªã‚»ãƒƒãƒˆ --- */
    html, body {
      margin: 0; padding: 0;
    }
    body {
      font-family: sans-serif;
    }
    /* --- ãƒ˜ãƒƒãƒ€ãƒ¼ --- */
    #toolbar {
      padding: 8px;
      background: #f7f6f5;
      border-bottom: 1px solid #ccc;
      position: sticky; top: 0; z-index: 1000;
      display: flex; align-items: center; gap: 8px;
    }
    /* ãƒ˜ãƒƒãƒ€ãƒ¼ã«æ®‹ã™ãƒœã‚¿ãƒ³ */
    #toolbar button, #toolbar input[type=file] {
      display: flex;
      margin-right: 4px;
    }
    /* --- ã‚³ãƒ³ãƒ†ãƒŠ --- */
    #container {
      display: flex;
      height: calc(100vh - 50px);
    }
    /* --- ã‚µã‚¤ãƒ‰ãƒãƒ¼ï¼ˆã‚¢ã‚¦ãƒˆãƒ©ã‚¤ãƒ³ï¼‰ --- */
    #sidebar {
      width: 200px;
      max-width: 500px;
      background: #f9f9f9;
      border-right: 1px solid #ccc;
      padding: 4px 8px;
      box-sizing: border-box;
      overflow-y: auto;
      position: relative;
      transition: width 0.2s ease;
    }
    #sidebar.hidden {
      width: 0;
      padding: 0;
      overflow: hidden;
    }
    #sidebar p{ font-size: 12px; color: #7d7d7d; }
    #outline { list-style:none; padding:0; margin:0; }
    #outline li { margin:0px 0; }
    #outline li.active > a { background:#ddd; }
    #outline .outline-item { text-decoration:none; font-size: 14px; color:#333333; display:block; padding:3px; border-radius:6px; cursor:pointer; margin: 2px 0px;}
    #outline .outline-item:hover { background:#f0f0f0; }
    #outline .outline-item.active { background:#e0e0e0;  font-weight:bold; }

    #toggleSidebar {
      position: static;
      top: 0.5em;
      leftt: 0.5em;
      width: 1.5em;
      height: 1.5em;
      border: 1px solid #999;
      border-radius: 0.25em;
      cursor: pointer;
      display: flex;
      align-items: center;
      justify-content: center;
      z-index: 10;
      visibility: visible !important;
    }

    #resizer {
      width: 5px;
      cursor: col-resize;
      background-color: transparent;
      position: absolute;
      top: 0;
      right: 0;
      height: 100%;
      z-index: 9;
    }

    /* --- ã‚¨ãƒ‡ã‚£ã‚¿é ˜åŸŸ --- */
    #editor {
      flex: 1;
      padding: 10px;
      overflow-y: auto;
      position: relative;
      background-color: #fffff9;
    }
    /* ãƒªã‚µã‚¤ã‚ºç”¨ã‚³ãƒ³ãƒ†ãƒŠ */
    .resizable-container {
      display: block;
      resize: both; overflow: auto;
      max-width: 100%;
      max-height: fit-content;
      margin:1em 0;
      border:1px dashed #ccc; position: relative;
    }
    .resizable-container img {
      width:100%; height:auto; display:block;
    }
    /* --- æµ®å‹•ãƒ„ãƒ¼ãƒ«ãƒãƒ¼ --- */
    #float-toolbar {
      position: absolute;
      display: none;
      background: #fff;
      border: 1px solid #ccc;
      border-radius: 4px;
      box-shadow: 0 2px 6px rgba(0,0,0,0.2);
      padding: 4px;
      z-index: 1001;
      display: flex;
      gap: 4px;
      align-items: center;
    }
    #float-toolbar button, #float-toolbar select {
      background: none;
      border: none;
      padding: 8px;
      cursor: pointer;
      font-size: 14px;
      border-radius: 3px;
    }
    #float-toolbar button:hover, #float-toolbar select:hover {
      background: #eee;
    }
    
    /* ã‚«ãƒ©ãƒ¼ãƒ”ãƒƒã‚«ãƒ¼é–¢é€£ */
    .color-picker-container {
      position: relative;
      display: inline-block;
    }
    
    .color-picker {
      position: absolute;
      top: 100%;
      left: 0;
      background: white;
      border: 1px solid #ccc;
      border-radius: 4px;
      padding: 8px;
      display: none;
      z-index: 1002;
      box-shadow: 0 2px 8px rgba(0,0,0,0.15);
      grid-template-columns: repeat(5, 1fr);
      gap: 4px;
      min-width: 120px;
    }
    
    .color-picker.show {
      display: grid;
    }
    
    .color-option {
      width: 20px;
      height: 20px;
      border-radius: 3px;
      cursor: pointer;
      border: 1px solid #ddd;
      display: flex;
      align-items: center;
      justify-content: center;
      font-size: 12px;
    }
    
    .color-option:hover {
      border-color: #999;
      transform: scale(1.1);
    }
    
    #textColorBtn {
      color: #000;
      font-weight: bold;
      position: relative;
    }
    
    #textColorBtn::after {
      content: '';
      position: absolute;
      bottom: 2px;
      left: 50%;
      transform: translateX(-50%);
      width: 12px;
      height: 2px;
      background: currentColor;
    }
  </style>
</head>
<body>

  <!-- ãƒ˜ãƒƒãƒ€ãƒ¼ï¼šãƒ•ã‚¡ã‚¤ãƒ«é¸æŠãƒ»ä¿å­˜ã®ã¿ -->
  <div id="toolbar">
    <div id="toggleSidebar" title="æŠ˜ã‚ŠãŸãŸã¿">Â«</div>
    <input type="file" accept=".html" onchange="loadFile(event)" title="èª­ã¿è¾¼ã¿">
    <button onclick="saveAs()" title="åå‰ã‚’ä»˜ã‘ã¦ä¿å­˜ (Ctrl+S)">ğŸ’¾ åå‰ã‚’ä»˜ã‘ã¦ä¿å­˜</button>
    <span id="lastModified" style="margin-left: auto; font-size: 12px; color: #666;"></span>
  </div>

  <div id="container">
    <!-- ã‚¢ã‚¦ãƒˆãƒ©ã‚¤ãƒ³ -->
    <div id="sidebar">
      <div id="resizer"></div>
      <P>ã‚¢ã‚¦ãƒˆãƒ©ã‚¤ãƒ³</P>
      <ul id="outline"></ul>
    </div>

    <!-- ç·¨é›†é ˜åŸŸ -->
    <div id="editor" contenteditable="true"
         ondrop="handleDrop(event)" ondragover="e=>e.preventDefault()">
      <h1>ã“ã“ã«æ–‡ç« ã‚’å…¥åŠ›ã—ã¦ãã ã•ã„...</h1>
    </div>
  </div>

  <!-- é¸æŠç¯„å›²æµ®å‹•ãƒ„ãƒ¼ãƒ«ãƒãƒ¼ -->
  <div id="float-toolbar">
    <button onclick="exec('bold')" title="å¤ªå­—">B</button>
    <button onclick="exec('italic')" title="æ–œä½“">I</button>
    <button onclick="exec('underline')" title="ä¸‹ç·š">U</button>
    <button onclick="exec('insertUnorderedList')" title="ç®‡æ¡æ›¸ã">â‹®â‰¡</button>
    <button onclick="exec('insertOrderedList')" title="ç•ªå·ä»˜ããƒªã‚¹ãƒˆ">Â¹â‚‚ï¼</button>
    <select onchange="exec('formatBlock', this.value)" title="è¦‹å‡ºã—/æ®µè½">
      <option value="P">ãƒ†ã‚­ã‚¹ãƒˆ</option>
      <option value="H1">è¦‹å‡ºã—1</option>
      <option value="H2">è¦‹å‡ºã—2</option>
      <option value="H3">è¦‹å‡ºã—3</option>
      <option value="H4">è¦‹å‡ºã—4</option>
    </select>
    <div class="color-picker-container">
      <button onclick="toggleColorPicker('text')" title="æ–‡å­—è‰²" id="textColorBtn">A</button>
      <div id="textColorPicker" class="color-picker">
        <div class="color-option" style="background-color: #24140e" onclick="setTextColor('#24140e')" title="ãƒ©ãƒ³ãƒ—ãƒ–ãƒ©ãƒƒã‚¯"></div>
        <div class="color-option" style="background-color: #abb1b5" onclick="setTextColor('#abb1b5')" title="ãƒ•ã‚©ãƒƒã‚°"></div>
        <div class="color-option" style="background-color: #946c45" onclick="setTextColor('#946c45')" title="ã‚«ãƒ•ã‚§ã‚ªãƒ¬"></div>
        <div class="color-option" style="background-color: #f39800" onclick="setTextColor('#f39800')" title="ãƒãƒªãƒ¼ã‚´ãƒ¼ãƒ«ãƒ‰"></div>
        <div class="color-option" style="background-color: #e9bc00" onclick="setTextColor('#e9bc00')" title="ãƒˆãƒ‘ãƒ¼ã‚º"></div>
        <div class="color-option" style="background-color: #578a3d" onclick="setTextColor('#578a3d')" title="ã‚¢ã‚¤ãƒ“ãƒ¼ã‚°ãƒªãƒ¼ãƒ³"></div>
        <div class="color-option" style="background-color: #0068b7" onclick="setTextColor('#0068b7')" title="ã‚³ãƒãƒ«ãƒˆãƒ–ãƒ«ãƒ¼"></div>
        <div class="color-option" style="background-color: #5a4498" onclick="setTextColor('#5a4498')" title="ãƒã‚¤ã‚ªãƒ¬ãƒƒãƒˆ"></div>
        <div class="color-option" style="background-color: #dc6b9a" onclick="setTextColor('#dc6b9a')" title="ã‚³ã‚¹ãƒ¢ã‚¹"></div>
        <div class="color-option" style="background-color: #ea5550" onclick="setTextColor('#ea5550')" title="ãƒãƒ”ãƒ¼ãƒ¬ãƒƒãƒ‰"></div>
      </div>
    </div>
    <div class="color-picker-container">
      <button onclick="toggleColorPicker('highlight')" title="ãƒã‚¤ãƒ©ã‚¤ãƒˆ" id="highlightBtn">ğŸ–</button>
      <div id="highlightColorPicker" class="color-picker">
        <div class="color-option" style="background-color: transparent; border: 1px solid #ccc" onclick="setHighlightColor('transparent')" title="ã‚¯ãƒªã‚¢">Ã—</div>
        <div class="color-option" style="background-color: #efefef" onclick="setHighlightColor('#efefef')" title="ã‚·ãƒ«ãƒãƒ¼ãƒ›ãƒ¯ã‚¤ãƒˆ"></div>
        <div class="color-option" style="background-color: #f6e5cc" onclick="setHighlightColor('#f6e5cc')" title="ã‚¨ã‚¯ãƒ«ãƒ™ãƒ¼ã‚¸ãƒ¥"></div>
        <div class="color-option" style="background-color: #fbd8b5" onclick="setHighlightColor('#fbd8b5')" title="ãƒ”ãƒ¼ãƒ"></div>
        <div class="color-option" style="background-color: #fff3b8" onclick="setHighlightColor('#fff3b8')" title="ã‚¯ãƒªãƒ¼ãƒ ã‚¤ã‚¨ãƒ­ãƒ¼"></div>
        <div class="color-option" style="background-color: #f0f6da" onclick="setHighlightColor('#f0f6da')" title="ãƒ›ãƒ¯ã‚¤ãƒˆãƒªãƒªãƒ¼"></div>
        <div class="color-option" style="background-color: #bbdbf3" onclick="setHighlightColor('#bbdbf3')" title="ãƒ•ãƒ­ã‚¹ãƒ†ã‚£ãƒ–ãƒ«ãƒ¼"></div>
        <div class="color-option" style="background-color: #d1bada" onclick="setHighlightColor('#d1bada')" title="ãƒ©ã‚¤ãƒ©ãƒƒã‚¯"></div>
        <div class="color-option" style="background-color: #e5c1cd" onclick="setHighlightColor('#e5c1cd')" title="ãƒ­ãƒ¼ã‚ºãƒ‰ãƒ©ã‚¸ã‚§"></div>
        <div class="color-option" style="background-color: #fbdac8" onclick="setHighlightColor('#fbdac8')" title="ã‚·ã‚§ãƒ«ãƒ”ãƒ³ã‚¯"></div>
      </div>
    </div>
  </div>

  <script>
  // PWA ServiceWorker ç™»éŒ²
  if ('serviceWorker' in navigator) {
    navigator.serviceWorker.register('service-worker.js');
  }

  let currentFilename = 'document.html';
  let lastModified = new Date(); // æœ€çµ‚æ›´æ–°æ—¥æ™‚
  const editor = document.getElementById('editor');
  const floatBar = document.getElementById('float-toolbar');
  
  // é¸æŠç¯„å›²ã‚’ä¿å­˜ã™ã‚‹ãŸã‚ã®å¤‰æ•°ï¼ˆæ”¹å–„ç‰ˆï¼‰
  let savedSelection = null;
  let savedSelectionData = null;

  // ã‚¢ã‚¦ãƒˆãƒ©ã‚¤ãƒ³æ›´æ–°é–¢æ•°ã‚’ã‚°ãƒ­ãƒ¼ãƒãƒ«ã‚¹ã‚³ãƒ¼ãƒ—ã«å®šç¾©
  function updateOutline() {
    const outline = document.getElementById('outline');
    outline.innerHTML = '';

    const headings = editor.querySelectorAll('h1, h2, h3, h4');
    headings.forEach((h, idx) => {
      const level = parseInt(h.tagName.substring(1));
      const link = document.createElement('div');
      link.textContent = h.textContent;
      link.style.marginLeft = (level - 1) * 16 + 'px';
      link.className = 'outline-item';
      link.dataset.headingIndex = idx; // è¦‹å‡ºã—ã®ã‚¤ãƒ³ãƒ‡ãƒƒã‚¯ã‚¹ã‚’ä¿å­˜
      link.onclick = () => {
        // ã‚¹ã‚¯ãƒ­ãƒ¼ãƒ«ã—ã¦è¦‹å‡ºã—ã‚’ä¸­å¤®ã«è¡¨ç¤º
        h.scrollIntoView({ behavior: 'smooth', block: 'center' });

        // è¦‹å‡ºã—ã«ã‚«ãƒ¼ã‚½ãƒ«ï¼ˆã‚­ãƒ£ãƒ¬ãƒƒãƒˆï¼‰ã‚’ç§»å‹•
        const range = document.createRange();
        range.selectNodeContents(h);
        range.collapse(true);

        const selection = window.getSelection();
        selection.removeAllRanges();
        selection.addRange(range);
        
        // ã‚¢ã‚¦ãƒˆãƒ©ã‚¤ãƒ³ã‚’ãƒã‚¤ãƒ©ã‚¤ãƒˆ
        updateOutlineHighlight();
      };
      outline.appendChild(link);
    });
    
    // ç¾åœ¨ã®ã‚«ãƒ¼ã‚½ãƒ«ä½ç½®ã«åŸºã¥ã„ã¦ãƒã‚¤ãƒ©ã‚¤ãƒˆã‚’æ›´æ–°
    updateOutlineHighlight();
  }

  // ã‚¢ã‚¦ãƒˆãƒ©ã‚¤ãƒ³ã®ãƒã‚¤ãƒ©ã‚¤ãƒˆã‚’æ›´æ–°ã™ã‚‹é–¢æ•°
  function updateOutlineHighlight() {
    const selection = window.getSelection();
    if (!selection.rangeCount) return;

    const range = selection.getRangeAt(0);
    const currentElement = range.startContainer.nodeType === Node.TEXT_NODE 
      ? range.startContainer.parentElement 
      : range.startContainer;

    // ç¾åœ¨ã®è¦ç´ ã‹ã‚‰æœ€ã‚‚è¿‘ã„è¦‹å‡ºã—ã‚’è¦‹ã¤ã‘ã‚‹
    let targetHeading = findCurrentOrPreviousHeading(currentElement);
    
    // å…¨ã¦ã®ã‚¢ã‚¦ãƒˆãƒ©ã‚¤ãƒ³é …ç›®ã‹ã‚‰activeã‚¯ãƒ©ã‚¹ã‚’å‰Šé™¤
    const outlineItems = document.querySelectorAll('.outline-item');
    outlineItems.forEach(item => item.classList.remove('active'));

    // å¯¾è±¡ã®è¦‹å‡ºã—ãŒã‚ã‚‹å ´åˆã€å¯¾å¿œã™ã‚‹ã‚¢ã‚¦ãƒˆãƒ©ã‚¤ãƒ³é …ç›®ã‚’ãƒã‚¤ãƒ©ã‚¤ãƒˆ
    if (targetHeading) {
      const headings = editor.querySelectorAll('h1, h2, h3, h4');
      const headingIndex = Array.from(headings).indexOf(targetHeading);
      if (headingIndex >= 0) {
        const targetOutlineItem = document.querySelector(`[data-heading-index="${headingIndex}"]`);
        if (targetOutlineItem) {
          targetOutlineItem.classList.add('active');
        }
      }
    }
  }

  // ç¾åœ¨ã®è¦ç´ ã¾ãŸã¯æ‰‹å‰ã®è¦‹å‡ºã—ã‚’è¦‹ã¤ã‘ã‚‹é–¢æ•°
  function findCurrentOrPreviousHeading(element) {
    // ç¾åœ¨ã®è¦ç´ ãŒè¦‹å‡ºã—ã®å ´åˆã¯ãã‚Œã‚’è¿”ã™
    if (element && element.matches && element.matches('h1, h2, h3, h4')) {
      return element;
    }

    // ã‚¨ãƒ‡ã‚£ã‚¿å†…ã®å…¨ã¦ã®è¦ç´ ã‚’å–å¾—
    const allElements = Array.from(editor.querySelectorAll('*'));
    const currentIndex = allElements.indexOf(element);

    // ç¾åœ¨ã®è¦ç´ ã‹ã‚‰å‰æ–¹ã«å‘ã‹ã£ã¦è¦‹å‡ºã—ã‚’æ¢ã™
    for (let i = currentIndex; i >= 0; i--) {
      const el = allElements[i];
      if (el.matches('h1, h2, h3, h4')) {
        return el;
      }
    }

    // ç¾åœ¨ã®è¦ç´ ã®è¦ªè¦ç´ ã‹ã‚‰å‰æ–¹ã®å…„å¼Ÿè¦ç´ ã‚’æ¢ã™
    let current = element;
    while (current && current !== editor) {
      let prev = current.previousElementSibling;
      while (prev) {
        if (prev.matches('h1, h2, h3, h4')) {
          return prev;
        }
        // å‰ã®è¦ç´ ã®å­è¦ç´ å†…ã®è¦‹å‡ºã—ã‚‚ç¢ºèª
        const headingInPrev = prev.querySelector('h1, h2, h3, h4:last-of-type');
        if (headingInPrev) {
          return headingInPrev;
        }
        prev = prev.previousElementSibling;
      }
      current = current.parentElement;
    }

    return null;
  }

  // é¸æŠç¯„å›²ã‚’ä¿å­˜ã™ã‚‹é–¢æ•°ï¼ˆæ”¹å–„ç‰ˆï¼‰
  function saveSelection() {
    const selection = window.getSelection();
    if (selection.rangeCount > 0) {
      const range = selection.getRangeAt(0);
      savedSelection = range.cloneRange();
      
      // è¿½åŠ ã®é¸æŠæƒ…å ±ã‚’ä¿å­˜
      savedSelectionData = {
        startContainer: range.startContainer,
        startOffset: range.startOffset,
        endContainer: range.endContainer,
        endOffset: range.endOffset,
        collapsed: range.collapsed
      };
    }
  }

  // ä¿å­˜ã—ãŸé¸æŠç¯„å›²ã‚’å¾©å…ƒã™ã‚‹é–¢æ•°ï¼ˆæ”¹å–„ç‰ˆï¼‰
  function restoreSelection() {
    if (savedSelection) {
      try {
        const selection = window.getSelection();
        selection.removeAllRanges();
        selection.addRange(savedSelection);
        return true;
      } catch (e) {
        // RangeãŒç„¡åŠ¹ã«ãªã£ãŸå ´åˆã®ä»£æ›¿å‡¦ç†
        if (savedSelectionData) {
          try {
            const range = document.createRange();
            range.setStart(savedSelectionData.startContainer, savedSelectionData.startOffset);
            range.setEnd(savedSelectionData.endContainer, savedSelectionData.endOffset);
            
            const selection = window.getSelection();
            selection.removeAllRanges();
            selection.addRange(range);
            return true;
          } catch (e2) {
            return false;
          }
        }
      }
    }
    return false;
  }

  // æ¨™æº–ã‚³ãƒãƒ³ãƒ‰å®Ÿè¡Œ
  function exec(cmd, val=null){
    document.execCommand(cmd, false, val);
    editor.focus();
    hideFloatBar();
  }

  // ã‚«ãƒ©ãƒ¼ãƒ”ãƒƒã‚«ãƒ¼ã®è¡¨ç¤º/éè¡¨ç¤ºï¼ˆæ”¹å–„ç‰ˆï¼‰
  function toggleColorPicker(type) {
    // é¸æŠç¯„å›²ã‚’ä¿å­˜
    saveSelection();
    
    const pickerId = type === 'text' ? 'textColorPicker' : 'highlightColorPicker';
    const picker = document.getElementById(pickerId);
    const otherPicker = document.getElementById(type === 'text' ? 'highlightColorPicker' : 'textColorPicker');
    
    // ä»–ã®ãƒ”ãƒƒã‚«ãƒ¼ã‚’é–‰ã˜ã‚‹
    otherPicker.classList.remove('show');
    
    // ç¾åœ¨ã®ãƒ”ãƒƒã‚«ãƒ¼ã‚’ãƒˆã‚°ãƒ«
    picker.classList.toggle('show');
    
    // ãƒ”ãƒƒã‚«ãƒ¼ãŒé–‹ã„ãŸå ´åˆã¯ã€ãƒã‚¦ã‚¹ã‚¤ãƒ™ãƒ³ãƒˆã‚’é˜²ã
    if (picker.classList.contains('show')) {
      picker.addEventListener('mousedown', function(e) {
        e.preventDefault();
      });
    }
  }

  // æ–‡å­—è‰²ã‚’è¨­å®šï¼ˆæ”¹å–„ç‰ˆï¼‰
  function setTextColor(color) {
    // é¸æŠç¯„å›²ã‚’å¾©å…ƒ
    if (restoreSelection()) {
      // å³åº§ã«ã‚³ãƒãƒ³ãƒ‰ã‚’å®Ÿè¡Œ
      const success = document.execCommand('foreColor', false, color);
      
      // ä»£æ›¿æ–¹æ³•ï¼ˆä¸€éƒ¨ã®ãƒ–ãƒ©ã‚¦ã‚¶ã§å¿…è¦ï¼‰
      if (!success) {
        try {
          const selection = window.getSelection();
          if (selection.rangeCount > 0) {
            const range = selection.getRangeAt(0);
            if (!range.collapsed) {
              const span = document.createElement('span');
              span.style.color = color;
              try {
                range.surroundContents(span);
              } catch (e) {
                // è¤‡é›‘ãªé¸æŠç¯„å›²ã®å ´åˆ
                const contents = range.extractContents();
                span.appendChild(contents);
                range.insertNode(span);
              }
            }
          }
        } catch (e) {
        }
      }
    }
    
    // ãƒœã‚¿ãƒ³ã®è‰²ã‚’æ›´æ–°
    document.getElementById('textColorBtn').style.color = color;
    
    // ãƒ”ãƒƒã‚«ãƒ¼ã‚’é–‰ã˜ã‚‹
    document.getElementById('textColorPicker').classList.remove('show');
    
    // ã‚¨ãƒ‡ã‚£ã‚¿ã«ãƒ•ã‚©ãƒ¼ã‚«ã‚¹ã‚’æˆ»ã™
    editor.focus();
    
    // æœ€çµ‚æ›´æ–°æ—¥æ™‚ã‚’æ›´æ–°
    updateLastModified();
  }

  // ãƒã‚¤ãƒ©ã‚¤ãƒˆè‰²ã‚’è¨­å®šï¼ˆæ”¹å–„ç‰ˆï¼‰
  function setHighlightColor(color) {
    // é¸æŠç¯„å›²ã‚’å¾©å…ƒ
    if (restoreSelection()) {
      if (color === 'transparent') {
        // ãƒã‚¤ãƒ©ã‚¤ãƒˆã‚’å‰Šé™¤
        document.execCommand('hiliteColor', false, 'transparent');
        document.execCommand('backColor', false, 'transparent');
      } else {
        // ãƒã‚¤ãƒ©ã‚¤ãƒˆè‰²ã‚’è¨­å®š
        let success = document.execCommand('hiliteColor', false, color);
        
        // Firefoxãªã©ä¸€éƒ¨ãƒ–ãƒ©ã‚¦ã‚¶ç”¨ã®ä»£æ›¿
        if (!success || !document.queryCommandSupported('hiliteColor')) {
          success = document.execCommand('backColor', false, color);
        }
        
        // ä»£æ›¿æ–¹æ³•
        if (!success) {
          try {
            const selection = window.getSelection();
            if (selection.rangeCount > 0) {
              const range = selection.getRangeAt(0);
              if (!range.collapsed) {
                const span = document.createElement('span');
                span.style.backgroundColor = color;
                try {
                  range.surroundContents(span);
                } catch (e) {
                  // è¤‡é›‘ãªé¸æŠç¯„å›²ã®å ´åˆ
                  const contents = range.extractContents();
                  span.appendChild(contents);
                  range.insertNode(span);
                }
              }
            }
          } catch (e) {
            console.warn('ãƒã‚¤ãƒ©ã‚¤ãƒˆè‰²ã®è¨­å®šã«å¤±æ•—ã—ã¾ã—ãŸ:', e);
          }
        }
      }
    }
    
    // ãƒ”ãƒƒã‚«ãƒ¼ã‚’é–‰ã˜ã‚‹
    document.getElementById('highlightColorPicker').classList.remove('show');
    
    // ã‚¨ãƒ‡ã‚£ã‚¿ã«ãƒ•ã‚©ãƒ¼ã‚«ã‚¹ã‚’æˆ»ã™
    editor.focus();
    
    // æœ€çµ‚æ›´æ–°æ—¥æ™‚ã‚’æ›´æ–°
    updateLastModified();
  }

  // File System Access API ãŒã‚µãƒãƒ¼ãƒˆã•ã‚Œã¦ã„ã‚‹ã‹ãƒã‚§ãƒƒã‚¯
  function isFileSystemAccessSupported() {
    return 'showSaveFilePicker' in window;
  }

  // æœ€çµ‚æ›´æ–°æ—¥æ™‚ã‚’æ›´æ–°ã—ã¦è¡¨ç¤º
  function updateLastModified() {
    lastModified = new Date();
    displayLastModified();
  }

  // æœ€çµ‚æ›´æ–°æ—¥æ™‚ã‚’è¡¨ç¤º
  function displayLastModified() {
    const lastModifiedElement = document.getElementById('lastModified');
    const formatted = lastModified.toLocaleString('ja-JP', {
      year: 'numeric',
      month: '2-digit',
      day: '2-digit',
      hour: '2-digit',
      minute: '2-digit'
    });
    lastModifiedElement.textContent = `æœ€çµ‚æ›´æ–°: ${formatted}`;
  }

  // åå‰ã‚’ä»˜ã‘ã¦ä¿å­˜
  async function saveAs() {
    const content = editor.innerHTML;
    const html = `<!DOCTYPE html><html><head><meta charset="UTF-8"><title>Document</title></head><body>${content}</body></html>`;

    if (isFileSystemAccessSupported()) {
      try {
        // File System Access API ã‚’ä½¿ç”¨ã—ã¦ãƒ•ã‚¡ã‚¤ãƒ«é¸æŠãƒ€ã‚¤ã‚¢ãƒ­ã‚°ã‚’è¡¨ç¤º
        const fileHandle = await window.showSaveFilePicker({
          suggestedName: currentFilename,
          types: [{
            description: 'HTML files',
            accept: {'text/html': ['.html']},
          }],
        });

        const writable = await fileHandle.createWritable();
        await writable.write(html);
        await writable.close();

        // ä¿å­˜ã•ã‚ŒãŸãƒ•ã‚¡ã‚¤ãƒ«ã®æƒ…å ±ã‚’æ›´æ–°
        currentFilename = fileHandle.name;
        
        // æˆåŠŸé€šçŸ¥ï¼ˆã‚ªãƒ—ã‚·ãƒ§ãƒ³ï¼‰
        showNotification(`${fileHandle.name} ã¨ã—ã¦ä¿å­˜ã—ã¾ã—ãŸ`);
      } catch (error) {
        if (error.name !== 'AbortError') {
          // ã‚¨ãƒ©ãƒ¼æ™‚ã¯å¾“æ¥ã®æ–¹æ³•ã«ãƒ•ã‚©ãƒ¼ãƒ«ãƒãƒƒã‚¯
          downloadFile(html, currentFilename);
        }
      }
    } else {
      // File System Access API ãŒä½¿ç”¨ã§ããªã„å ´åˆã¯å¾“æ¥ã®æ–¹æ³•
      downloadFile(html, currentFilename);
    }
  }

  // å¾“æ¥ã®ãƒ€ã‚¦ãƒ³ãƒ­ãƒ¼ãƒ‰æ–¹å¼
  function downloadFile(content, filename) {
    const blob = new Blob([content], {type:'text/html'});
    const a = document.createElement('a');
    a.href = URL.createObjectURL(blob);
    a.download = filename;
    a.click();
    URL.revokeObjectURL(a.href);
  }

  // é€šçŸ¥è¡¨ç¤ºï¼ˆã‚ªãƒ—ã‚·ãƒ§ãƒ³ï¼‰
  function showNotification(message) {
    // ç°¡å˜ãªé€šçŸ¥ã‚’è¡¨ç¤º
    const notification = document.createElement('div');
    notification.textContent = message;
    notification.style.cssText = `
      position: fixed;
      top: 20px;
      right: 20px;
      background: #4CAF50;
      color: white;
      padding: 12px 20px;
      border-radius: 4px;
      box-shadow: 0 2px 8px rgba(0,0,0,0.2);
      z-index: 10000;
      font-size: 14px;
    `;
    document.body.appendChild(notification);
    
    setTimeout(() => {
      notification.remove();
    }, 3000);
  }

  // èª­ã¿è¾¼ã¿
  async function loadFile(e) {
    const f = e.target.files[0];
    if (!f) return;
    
    currentFilename = f.name;
    
    const r = new FileReader();
    r.onload = ev => {
      const tmp = document.createElement('div');
      tmp.innerHTML = ev.target.result;
      const b = tmp.querySelector('body');
      editor.innerHTML = b ? b.innerHTML : tmp.innerHTML;
      
      // ãƒ•ã‚¡ã‚¤ãƒ«ã®æœ€çµ‚æ›´æ–°æ—¥æ™‚ã‚’è¨­å®š
      lastModified = new Date(f.lastModified);
      displayLastModified();
      
      // ãƒ•ã‚¡ã‚¤ãƒ«èª­ã¿è¾¼ã¿å¾Œã«ã‚¢ã‚¦ãƒˆãƒ©ã‚¤ãƒ³ã‚’æ›´æ–°
      updateOutline();
      showNotification(`${f.name} ã‚’èª­ã¿è¾¼ã¿ã¾ã—ãŸ`);
    };
    r.readAsText(f);
    document.body.style.margin = '0';
    document.body.style.padding = '0';
  }

  // PWA ServiceWorker ç™»éŒ²ï¼ˆé‡è¤‡å‰Šé™¤ï¼‰
  if ('serviceWorker' in navigator) {
    window.addEventListener('load', () => {
      navigator.serviceWorker.register('sw.js');
    });
  }

  document.addEventListener('DOMContentLoaded', () => {
    // Ctrl+S ã‚­ãƒ¼ãƒœãƒ¼ãƒ‰ã‚·ãƒ§ãƒ¼ãƒˆã‚«ãƒƒãƒˆã®è¿½åŠ 
    document.addEventListener('keydown', (e) => {
      if ((e.ctrlKey || e.metaKey) && e.key === 's') {
        e.preventDefault();
        saveAs();
      }
    });

    // ã‚¨ãƒ‡ã‚£ã‚¿ã®å†…å®¹ãŒå¤‰æ›´ã•ã‚ŒãŸã¨ãã«æœ€çµ‚æ›´æ–°æ—¥æ™‚ã‚’æ›´æ–°
    editor.addEventListener('input', () => {
      updateLastModified();
      updateOutline();
    });

    // ã‚¢ã‚¦ãƒˆãƒ©ã‚¤ãƒ³ã‚’è‡ªå‹•æ›´æ–°
    editor.addEventListener('keydown', updateOutline);
    editor.addEventListener('mouseup', updateOutline);

    // åˆæœŸè¡¨ç¤ºæ™‚ã«æœ€çµ‚æ›´æ–°æ—¥æ™‚ã‚’è¡¨ç¤º
    displayLastModified();

    // ã‚«ãƒ¼ã‚½ãƒ«ä½ç½®å¤‰æ›´æ™‚ã®ãƒã‚¤ãƒ©ã‚¤ãƒˆæ›´æ–°
    editor.addEventListener('keyup', updateOutlineHighlight);
    editor.addEventListener('click', updateOutlineHighlight);
    document.addEventListener('selectionchange', () => {
      // selectionå¤‰æ›´ãŒã‚¨ãƒ‡ã‚£ã‚¿å†…ã§ç™ºç”Ÿã—ãŸå ´åˆã®ã¿å‡¦ç†
      const selection = window.getSelection();
      if (selection.rangeCount > 0) {
        const range = selection.getRangeAt(0);
        const container = range.commonAncestorContainer;
        if (editor.contains(container) || container === editor) {
          updateOutlineHighlight();
        }
      }
    });

    // ã‚µã‚¤ãƒ‰ãƒãƒ¼ã®æŠ˜ã‚ŠãŸãŸã¿
    const sidebar = document.getElementById('sidebar');
    const toggleSidebarBtn = document.getElementById('toggleSidebar');
    let sidebarWidth = 200; // ãƒ‡ãƒ•ã‚©ãƒ«ãƒˆå¹…ã‚’ä¿å­˜
    
    toggleSidebarBtn.addEventListener('click', () => {
      if (sidebar.classList.contains('hidden')) {
        // å±•é–‹ï¼šä¿å­˜ã•ã‚ŒãŸå¹…ã‚’å¾©å…ƒ
        sidebar.classList.remove('hidden');
        sidebar.style.width = sidebarWidth + 'px';
        toggleSidebarBtn.innerText = 'Â«';
      } else {
        // æŠ˜ã‚ŠãŸãŸã¿ï¼šç¾åœ¨ã®å¹…ã‚’ä¿å­˜ã—ã¦ã‹ã‚‰éè¡¨ç¤º
        const currentWidth = sidebar.offsetWidth;
        if (currentWidth > 0) {
          sidebarWidth = currentWidth;
        }
        sidebar.classList.add('hidden');
        sidebar.style.width = '0px';
        toggleSidebarBtn.innerText = 'â˜°';
      }
    });

    // ã‚µã‚¤ãƒ‰ãƒãƒ¼å¹…ã®ãƒªã‚µã‚¤ã‚º
    const resizer = document.getElementById('resizer');
    let isResizing = false;

    resizer.addEventListener('mousedown', (e) => {
      // æŠ˜ã‚ŠãŸãŸã¾ã‚Œã¦ã„ã‚‹å ´åˆã¯ãƒªã‚µã‚¤ã‚ºã‚’ç„¡åŠ¹åŒ–
      if (sidebar.classList.contains('hidden')) {
        return;
      }
      isResizing = true;
      document.body.style.cursor = 'col-resize';
      e.preventDefault();
    });

    document.addEventListener('mousemove', (e) => {
      if (!isResizing || sidebar.classList.contains('hidden')) return;
      
      const newWidth = Math.max(100, Math.min(500, e.clientX));
      sidebar.style.width = `${newWidth}px`;
      sidebarWidth = newWidth; // å¹…ã‚’ä¿å­˜
    });

    document.addEventListener('mouseup', () => {
      if (isResizing) {
        isResizing = false;
        document.body.style.cursor = 'default';
      }
    });

    // åˆæœŸåŒ–
    updateOutline();
  });

  // ç”»åƒãƒ‰ãƒ­ãƒƒãƒ—ï¼æŒ¿å…¥
  function handleDrop(e){
    e.preventDefault();
    Array.from(e.dataTransfer.files).forEach(file=>{
      if(file.type.startsWith('image/')){
        const reader = new FileReader();
        reader.onload=ev=>{
          const wrap = document.createElement('div');
          wrap.className='resizable-container';
          const img = document.createElement('img');
          img.src = ev.target.result;
          wrap.appendChild(img);
          insertAtCursor(wrap);
        };
        reader.readAsDataURL(file);
      }
    });
    updateOutline();
  }

  // ã‚«ãƒ¼ã‚½ãƒ«ä½ç½®ã«ãƒãƒ¼ãƒ‰æŒ¿å…¥
  function insertAtCursor(node){
    const sel = window.getSelection();
    if(!sel.rangeCount) return;
    const range = sel.getRangeAt(0);
    range.deleteContents();
    range.insertNode(node);
  }

  // é¸æŠç¯„å›²æ™‚ã«æµ®å‹•ãƒ¡ãƒ‹ãƒ¥ãƒ¼è¡¨ç¤ºï¼ˆæ”¹å–„ç‰ˆï¼‰
  document.addEventListener('mouseup', e=>{
    setTimeout(()=>{ // é¸æŠåæ˜ å¾…ã¡
      const sel = window.getSelection();
      
      if(sel.isCollapsed) { 
        hideFloatBar(); 
        return; 
      }
      
      // é¸æŠç¯„å›²ãŒã‚¨ãƒ‡ã‚£ã‚¿å†…ã«ã‚ã‚‹ã‹ãƒã‚§ãƒƒã‚¯
      const range = sel.getRangeAt(0);
      const container = range.commonAncestorContainer;
      
      // ãƒ†ã‚­ã‚¹ãƒˆãƒãƒ¼ãƒ‰ã®å ´åˆã¯è¦ªè¦ç´ ã‚’ãƒã‚§ãƒƒã‚¯
      const containerElement = container.nodeType === Node.TEXT_NODE 
        ? container.parentElement 
        : container;
      
      // ã‚¨ãƒ‡ã‚£ã‚¿å†…ã®é¸æŠã§ãªã„å ´åˆã¯éè¡¨ç¤º
      if (!editor.contains(containerElement) && containerElement !== editor) {
        hideFloatBar();
        return;
      }
      
      // é¸æŠç¯„å›²ã‚’ä¿å­˜ï¼ˆæµ®å‹•ãƒ„ãƒ¼ãƒ«ãƒãƒ¼è¡¨ç¤ºæ™‚ï¼‰
      saveSelection();
      
      // ã¾ãšè¡¨ç¤ºã—ã¦ã‚µã‚¤ã‚ºã‚’å–å¾—
      floatBar.style.display = 'flex';
      floatBar.style.position = "absolute";
      floatBar.style.visibility = 'hidden'; // ã‚µã‚¤ã‚ºè¨ˆç®—ã®ãŸã‚ä¸€æ™‚çš„ã«éè¡¨ç¤º
      
      const rect = range.getBoundingClientRect();
      const toolbarRect = floatBar.getBoundingClientRect();
      
      // åˆæœŸä½ç½®ã‚’è¨­å®šï¼ˆé¸æŠç¯„å›²ã®ä¸Šä¸­å¤®ï¼‰
      let top = rect.top - toolbarRect.height - 8;
      let left = rect.left + (rect.width / 2) - (toolbarRect.width / 2);
      
      // ãƒ“ãƒ¥ãƒ¼ãƒãƒ¼ãƒˆã®å¢ƒç•Œã‚’å–å¾—
      const viewportWidth = window.innerWidth;
      const viewportHeight = window.innerHeight;
      
      // å·¦å³ã®èª¿æ•´
      if (left < 10) {
        left = 10; // å·¦ç«¯ã‹ã‚‰10px
      } else if (left + toolbarRect.width > viewportWidth - 10) {
        left = viewportWidth - toolbarRect.width - 10; // å³ç«¯ã‹ã‚‰10px
      }
      
      // ä¸Šä¸‹ã®èª¿æ•´
      if (top < 10) {
        // ä¸Šã«ã¯ã¿å‡ºã‚‹å ´åˆã¯é¸æŠç¯„å›²ã®ä¸‹ã«è¡¨ç¤º
        top = rect.bottom + 8;
      }
      
      if (top + toolbarRect.height > viewportHeight - 10) {
        // ä¸‹ã«ã¯ã¿å‡ºã‚‹å ´åˆã¯å†åº¦ä¸Šã«èª¿æ•´
        top = rect.top - toolbarRect.height - 8;
        if (top < 10) {
          // ãã‚Œã§ã‚‚ä¸Šã«ã¯ã¿å‡ºã‚‹å ´åˆã¯é¸æŠç¯„å›²ã¨é‡ãªã£ã¦ã‚‚è¡¨ç¤º
          top = 10;
        }
      }
      
      // ã‚¹ã‚¯ãƒ­ãƒ¼ãƒ«ä½ç½®ã‚’è€ƒæ…®ã—ã¦æœ€çµ‚ä½ç½®ã‚’è¨­å®š
      floatBar.style.top = (top + window.scrollY) + 'px';
      floatBar.style.left = (left + window.scrollX) + 'px';
      floatBar.style.visibility = 'visible'; // è¡¨ç¤º
    }, 10);
  });

  // éè¡¨ç¤º
  function hideFloatBar(){
    floatBar.style.display = 'none';
    // ã‚«ãƒ©ãƒ¼ãƒ”ãƒƒã‚«ãƒ¼ã‚‚é–‰ã˜ã‚‹
    document.getElementById('textColorPicker').classList.remove('show');
    document.getElementById('highlightColorPicker').classList.remove('show');
  }

  // ã‚¯ãƒªãƒƒã‚¯æ™‚ã«æ¶ˆã™ï¼ˆé¸æŠå¤–ï¼‰
  document.addEventListener('mousedown', e=>{
    if(!floatBar.contains(e.target)) {
      hideFloatBar();
    }
  });

  // ã‚¨ãƒ‡ã‚£ã‚¿ä»¥å¤–ã§ã®selectionchangeæ™‚ã¯æµ®å‹•ãƒ„ãƒ¼ãƒ«ãƒãƒ¼ã‚’éš ã™
  document.addEventListener('selectionchange', () => {
    const selection = window.getSelection();
    if (selection.rangeCount > 0) {
      const range = selection.getRangeAt(0);
      const container = range.commonAncestorContainer;
      const containerElement = container.nodeType === Node.TEXT_NODE 
        ? container.parentElement 
        : container;
      
      // ã‚¨ãƒ‡ã‚£ã‚¿å¤–ã®é¸æŠã®å ´åˆã¯æµ®å‹•ãƒ„ãƒ¼ãƒ«ãƒãƒ¼ã‚’éè¡¨ç¤º
      if (!editor.contains(containerElement) && containerElement !== editor) {
        hideFloatBar();
      }
    } else {
      hideFloatBar();
    }
  });

  </script>

</body>
</html>